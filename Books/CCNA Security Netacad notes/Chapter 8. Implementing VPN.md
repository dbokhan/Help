# Глава 8. Внедрение виртуальных частных сетей (VPN)

**Разворот пакетов (Hairpinning)** – термин, используемый для описания ситуации, при которой VPN-трафик, входящий в интерфейс, также может маршрутизироваться на выходе из того же интерфейса.

**Метод разделенного туннелирования (Split tunneling)** - Если трафик предназначен для корпоративной подсети, он отправляется через VPN-туннель. В противном случае он отправляется в виде нешифрованного (недоверенного) трафика в Интернет.

## Компоненты сети IPsec VPN и их функционирование

![](img/IPSec_structure.png)

**Алгоритм Диффи-Хеллмана (DH)** - это метод обмена открытыми ключами, с помощью которого два равноправных узла могут установить общий секретный ключ, который знают только они, даже в том случае, если эти узлы взаимодействуют друг с другом по незащищенному каналу. 
- Группы DH 1, 2, 5 не рекомендуется использовать после 2012 года.
- Группы DH 14, 15, 16 рекомендуется использовать до 2030 года.
- Группы DH 19, 20, 21, 24 предпочтительные методы.



Основными протоколами IPsec являются:
- Authentication Header (AH)
- Encapsulation Security Protocol (ESP)

В зависимости от выбора основного протокола будут выбраны какие структуры (_как на картинке_) будут использованы.

Основное отличие ESP от AH - это поддержка шифрования.

Оба протокола ESP и AH могут работать в *Транспортном* или *Туннельном* режимах. 

**Транспортный режим** - защищает полезную нагрузку в IP пакете, но поля пакета (в том числе адресацию) оставляет открытыми. 

**Туннельный режим** - исходный IP пакет полностью шифруется, а затем инкапсулируется в новый IP пакет.



**Протокол IKE** - используется вместе с IPsec для упрощения настройки IPsec. Он создает SA для согласования параметров IPsec между сторонами. 

Это гибридный протокол, реализующий протоколы обмена ключами на базе платформы Internet Security Association Key Management Protocol (ISAKMP). ISAKMP определяет формат сообщений, механизм протокола обмена ключами и процесс согласования.

IKE использует UDP порт 500.