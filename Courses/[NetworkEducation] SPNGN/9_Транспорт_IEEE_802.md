# Транспорт IEEE 802

## Коммутируемый Ethernet

> Сегодняшний Ethernet (коммутируемый Ethernet) не является чистым L2. Чистый L2 Ethernet был в Толстом Желтом Коаксиале (ТЖК). Передача сигналов из одного домена коллизии в другой, выполняемая коммутатором, по сути является задачей межсетевого взаимодействия, т.е. уровня L3. Коммутируемый Ethernet выполняет коммутацию в соответсвтии с IEEE 802.1D

** Разные домены коллизий объединены в общий широковещательный домен**

** Для терминального узла на MAC-подуровне неотличим от "честного" L2**

## Принцип работы коммутатора

**Получить аналоговый сигнал на входном порту**

**Декодировать кадо и временно сохранить его в буферной памяти**

**Принять коммутационное решение**

- **В какие порты копию кадра передавать не надо**

  - Не надо отправлять копию кадра в тот же порт, откуда получен кадр

  - Не надо отправлять копию кадра в порт из той же группы агрегации

  - Не надо отправлять компию кадра в порт, заблокированный STP

  - Не надо отправлять компию кадра в порт, заблокированный Storm Control

  - Не надо отправлять компию кадра в порт, если получатель известен за другим портом

  - Не надо отправлять компию кадра в порт, который не ассоциирован с тем же VLAN UD

  - ... и так далее

**Скопировать копию кадра в исзодящие буферы остальных портов**

**Передать кодр и после успешной передачи стереть его из буфера**

## Таблица коммутации

**Пары MAC-адрес-порт, про которые известно коммутаторы (или тройка MAC-адрес-VLAN-порт)**

**Пополняется автоматически с помощью MAC Learning**

- Один MAC-адрес не может быть виден за несколькими портами

- Но за одним и тем же портом может быть видно несколько MAC-адресов

- Если кадр от известного MAC приходит с другого порта - запись заменяется 

- Записи, как правило, живут ограниченное время

**Процесс MAC Learning помогает фильтровать юникастовые кадры на портах, за которыми не находится получатель**

- Не требует синхронизации между устройствами

- Основывается на предположении, чтовсе работает по стандарту

- Дает катастрофические сбои, если что-то работает не по стандарту

## Коммутация с VLAN

**MAC Learning идет в несколько таблиц коммутации**

- Кадр коммутируется только по одной из них (отдельный вопрос - по какой)

- Максимальной поддерживаемое число таблиц обычно меньше 4094

## IEEE 802.1ad (QinQ)

**Возможность использования в кадре нескольких меток 802.1Q**:

- Внешняя метка (S-tag) - для использования в сети Carrier Ethernet

  - Часто для S-tag использует используется EtherType 0x88A8

- Внутренняя (C-tag) - для возможного использования потребитерем

**Позволяет потребителю и оператору использовать произвольные метки 802.1Q независимо друг от друга**

- MAC - адресация, однако, остается единой

| Преамбула | Получатель | Отправитель | S-TPID | S-TCI  | C-TPID | C-TCI  | EtherType | Data           | FCS    |
|-----------|------------|-------------|--------|--------|--------|--------|-----------|----------------|--------|
| 8 byte    | 6 byte     | 6 byte      | 2 byte | 2 byte | 2 byte | 2 byte | 2 byte    | 46 - 1500 byte | 4 byte |
|           |            |             |        |        |        |        |           |                |        |

> Стандартное значения поля TCI или C-TCI для кадров 802.1Q = 0x8100 оно определяет инкапсуляцию 802.1Q, а при QinQ VLAN добавляется S-TPID с значением 0x88A8, которая обозначает что это обычная 802.1Q метка, но приставленная еще к одной 802.1Q метке
>
> S-TPID и S-TCI обычно назначаются провайдерами, а C-TPID и C-TCI клинетами провайдера

> Плохая сторона QinQ в том, что MAC адресация не изменяется, т.е. теоретически провайдер запоминает все MAC адреса, которые ходят через этот канал, что может забить память провайдерским железкам.

> 802.1ad это именно про метку 0x88A8, а просто QinQ это вложение обычных 802.1q (с метками 0x8100) друг в друга 