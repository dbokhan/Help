# Транспорт IEEE 802

## Коммутируемый Ethernet

> Сегодняшний Ethernet (коммутируемый Ethernet) не является чистым L2. Чистый L2 Ethernet был в Толстом Желтом Коаксиале (ТЖК). Передача сигналов из одного домена коллизии в другой, выполняемая коммутатором, по сути является задачей межсетевого взаимодействия, т.е. уровня L3. Коммутируемый Ethernet выполняет коммутацию в соответсвтии с IEEE 802.1D

**Разные домены коллизий объединены в общий широковещательный домен**

**Для терминального узла на MAC-подуровне неотличим от "честного" L2**

## Принцип работы коммутатора

**1. Получить аналоговый сигнал на входном порту**

**2. Декодировать кадр и временно сохранить его в буферной памяти**

**3. Принять коммутационное решение:**

- **В какие порты копию кадра передавать не надо**

  - Не надо отправлять копию кадра в тот же порт, откуда получен кадр

  - Не надо отправлять копию кадра в порт из той же группы агрегации

  - Не надо отправлять копию кадра в порт, заблокированный STP

  - Не надо отправлять копию кадра в порт, заблокированный Storm Control

  - Не надо отправлять копию кадра в порт, если получатель известен за другим портом

  - Не надо отправлять копию кадра в порт, который не ассоциирован с тем же VLAN ID

  - ... и так далее

**4. Скопировать копию кадра в исходящие буферы остальных портов**

**5. Передать кадр и после успешной передачи стереть его из буфера**

## Таблица коммутации

Пары MAC-адрес-порт, про которые известно коммутаторам (или тройка MAC-адрес-VLAN-порт), пополняется автоматически с помощью **MAC Learning**:

- Один MAC-адрес не может быть виден за несколькими портами

- Но за одним и тем же портом может быть видно несколько MAC-адресов

- Если кадр от известного MAC приходит с другого порта - запись заменяется 

- Записи, как правило, живут ограниченное время

**Процесс MAC Learning помогает фильтровать юникастовые кадры на портах, за которыми не находится получатель**:

- Не требует синхронизации между устройствами

- Основывается на предположении, чтовсе работает по стандарту

- Дает катастрофические сбои, если что-то работает не по стандарту

## Коммутация с VLAN

**MAC Learning идет в несколько таблиц коммутации**

- Кадр коммутируется только по одной из них (отдельный вопрос - по какой)

- Максимальной поддерживаемое число таблиц обычно меньше 4094

## IEEE 802.1ad (QinQ)

**Возможность использования в кадре нескольких меток 802.1Q**:

- Внешняя метка (S-tag) - для использования в сети Carrier Ethernet

  - Часто для S-tag использует используется EtherType 0x88A8

- Внутренняя (C-tag) - для возможного использования потребителем

**Позволяет потребителю и оператору использовать произвольные метки 802.1Q независимо друг от друга**

- MAC - адресация, однако, остается единой

| Преамбула | Получатель | Отправитель | S-TPID | S-TCI  | C-TPID | C-TCI  | EtherType | Data           | FCS    |
|-----------|------------|-------------|--------|--------|--------|--------|-----------|----------------|--------|
| 8 byte    | 6 byte     | 6 byte      | 2 byte | 2 byte | 2 byte | 2 byte | 2 byte    | 46 - 1500 byte | 4 byte |

> Стандартное значения поля TPID или C-TPID для кадров 802.1Q = 0x8100, оно определяет инкапсуляцию 802.1Q, а при QinQ VLAN добавляется S-TPID с значением 0x88A8, которая обозначает что это обычная 802.1Q метка, но приставленная еще к одной 802.1Q метке
>
> S-TPID и S-TCI обычно назначаются провайдерами, а C-TPID и C-TCI клинетами провайдера

> В полях TCI находятся номера VLAN'ов

> **Плохая сторона QinQ в том, что MAC адресация не изменяется, т.е. теоретически провайдер запоминает все MAC адреса, которые ходят через этот канал, что может забить память провайдерским железкам.**

> Формально 802.1ad это именно про метку 0x88A8, а просто QinQ это вложение обычных 802.1q (с метками 0x8100) друг в друга 

## IEEE 802.1ah (MAC-in-MAC)

> IEEE 802.1ah (MAC-in-MAC) по сути решает задачу как 802.1ad, но позволяет провайдерам не запоминать мак адреса клиентов с помощью добавления новых Destination и Source MAC адресов.

* **Provider Backbone Bridges (PBB)**:

  * Механизм оборачивания пользовательского кадра сервисным заголовком

  * Использует EtherType 0x88A8 для B-TPID и 0x88E7 для S-TPID

  * Позволяет польностью абстрагироваться от пользовательской адресации

* **Имеет достаточно обширный заголовок**:
  
  * B-VID (backbone VLAN ID) осуществляет коммутацию в сети провайдера

  * I-SID (Service Instance VLAN ID) задает код усуги в домене PBB

| Преамбула | B-DA   | B-SA   | B-TPID | B-TCI  | S-TPID | S-Flags | I-SID  | C-DA   | C-SA   | Data           | FCS    |
|-----------|--------|--------|--------|--------|--------|---------|--------|--------|--------|----------------|--------|
| 8 byte    | 6 byte | 6 byte | 2 byte | 2 byte | 2 byte | 1 byte  | 3 byte | 6 byte | 6 byte | 46 - 1500 byte | 4 byte |

## OAM

* **Ethernet Connectivity Fault Managmenet, IEEE 802.1ag**:

  * Maintenance intermediate point (MIPs) - настраивается оператором

  * Maintenance end point (MEPs) - настраиваются клиентом

* **Кадр формата 802.2 SNAP ("slow portocol")**:

  * Continuity Check Messages - мультикастовой обнаружение между MEP

  * Loopback Messages - юникастовый "пинг"

  * Traceroute Messages - мультикастовая трассировка с юникастовыми ответами

(Client Equipment1 - MEP) <--> (MIP - Provider Equipment1) <--> (Provider Equipment2 - MIP) <--> (MEP - Client Equipment2)

> P.S. OAM по сути является аналогом icmp, но реализованный на канальном уровне с помощью кадров ethernet.

## Недостатки концепции бриджинга

* Излишнее доверие к заголовку кадра в процедуре MAC Learning

* Неудобство полносвязной топологии для оператоских задач

* Отсутствие штатного резерирования каналов и балансировки

  * Агрегация каналов

  * Spanning Tree

  * Resilient Ethernet Protocol

* Проблема с точкой отказа в предоставлении IP-сервисов

  * HSRP

  * VRRP

  * GLBP

## Агрегация интерфейсов Ethernet

* **Обхединение несколькиз физических портов (агрегируемых, bundled) Ethernet в один агрегатный логический порт (bundle)**

* **Агрегация работает за счет изменения логики коммутации**:

  * Отправляемый в агрегатный интерфейс кодр по некоторму алгоритму отправляется в исходящий буфер одного из физическиз интерфейсов

  * Коммутация между агрегируемыми интерфейсами не выполняется

* **Изначально описана в IEEE 802.3ad-2000, затем в IEEE 802.1AX-2008**:

  * Разработана Kalpana, производителем первых Ethernet-коммутаторов

  * Фирменное название - Cisco EtherChannel (агрегация + балансировщик)

> Не стоит думать об агрегации как об технологии, которая повышает производительность. Ее основная задача - обеспечение отказоустойчивости, а возможное увеличение производительности является побочным эффектом.

### Балансировщик

* **Порты в агрегированном канале загружаются одновременно**

  * Но не обязательно равномерно

* **При отказе одного из агрегируемых физическиз портов**:

  * После определения отказа новые кадры в порт не отправляются

  * Кадры, уже находящиеся в буфере, теряются

> Для того чтобы избежать resequencing'а (reordering) кадров в агрегированном канале кадры отправляются, в зависимости от сессии, каждая в свой провод. Для того чтобы не держать таблицу всех протоколов для отслеживания сессии от всего кадра вычисляется "типо хэш" и таким образом балансировщик раскидывает каждую сессию по проводам. На самом деле используется не хэш, а операция xor и последние 4 бита определяют сессию.

### Преимущества и недостатки агрегации

* Повышает надежность канала

* При удачно выбранном механизме балансировки повышается теоретически доступная полоса пропускания

* Гарантированная скорость равна скорости одного интерфейса

* При неудачно выранном механизме балансировки скорость не повышается, возможна смена порядка кадров (reordering)

### Требованияк топологии

* Агрегировать можно толко порты, подключенные к одному и тому же удаленному устройству (иначе тяжело определить петлю)

* Рекомендуется агрегировать однотипно настроенные порты

* Особенность балансировщика Cisco - использование 3 бит энтропии (которые используются для определения сессий)

  * Агрегирует до 8 портов (плюс горячая замена)

  MLAG - агрегация портов к разным коммутаторам, которые находятся в одном стеке

### Процедуры контроля агрегации

* **Перед включение портов необходимо проверить топологию**

  * Все порты подключены к одному и тому же удаленному устройству

  * Все порты на удаленном устройстве тоже агрегированы в логический канал

* **Статическая агрегация** - ничего не проверяется

* **LACP (Link Aggregation Control Protocol)** - протокол 802.3ad/802.1AX

* **PAgP (Port Aggregation Control Protocol)** - проприетарный протокол

## Spanning Tree Protocol

* Семейство протоколов, блокирующих коммутацию кадров на портах, формирующих петлю в Ethernet

* Используется "алгоритм остовного дерева"

* Разработан Радьей Перлман в 1985 г.

* IEEE включила STP в 802.1D-1990

* Существуют другие стандартные версии STP

  * 802.1w - Rapid Spanning Tree, впоследствии объединен с 802.1D-2004

  * 802.1s - Multiple Spanning Trees, впоследствии объединен с 802.1Q-2003

* Кроме того, существуют и нестандартные реализации

  * PVST/PVRST - проприетарное расширение Cisco для работы с VLAN

### Принцип работы STP

* Заблокировать все порты, которые могут участвовать в петле

* Определить "центральную" точку сети

* Разблокировать на каждом коммутаторе порт, с помощью которого до "центральной" точки можно отправить кадр "лучшим" образом

* Разблокировать на каждом коммутаторе порты, с помощью которых до "центральной" точки добраться нельзя

* Все остальные порты оставить заблокированными

### STP и VLAN

* STP блокирует коммутацию на порту без учета информации о VLAN

  * Остовное дерево в 802.1D строится по всей физической топологии, а не по отдельным логическим виртуальным поддоменам (VLAN)

* Есть вероятность блокировки коммутации там, где физически петля существует, но логически ее нет (равно как нет и последствий петли)

### Rapid Spanning Tree

* Использует тот же алгоритм остовного дерева, что и STP

  * По тому же принципу выбираются корневой коммутатор и forwarding-порты

  * Обратно совместим с "медленным" STP

* Значительно уменьшает как время пересчета топологии, так и время восстановления работоспособности сети после отказа

  * В основном за счет отказа от поддержки топологий с общей шиной

* Особенно влияют на ускорение:

  * Появление сообщений "запрос-ответ", синхронизирующих состояние двух коммутаторов на P2P-канале не за Hello time, а за единицы миллисекунд

  * Появление Edge port, на котором коммутация выполняется сразу после включения (но возможно кратковременное формирование петли)

### PVST/PVST+/PVRST

* PVST - проприетарный протокол Cisco на основе 802.1D-1990 с поддержкой VLAN и мезанизмами ускорения работы (STP Toolkit)

  * PVST поддерживает только транки ISL

  * PVST+ поддержкивает транки 802.1Q

* PVRST (Rapid PVST+) - проприетарный протокол на основе 802.1w

* Строит остовное дерево не по физической топологии, а по VLAN

### MST (Multiple Spanning Tree)

* Стандартный протокол IEEE 802.1Q

* Поддержка нескольких деревьев

* Необходимо "привязать" VLANы к деревьям

  * Если "привязка" не совпадает, возможна петля

* Симуляция STP/RSTP встроена в протокол, используется дерево CIST

### Время сходимости STP

* STP/PVST: 30-60 секунд с таймерами по умолчанию

  * Можно настроить с субсекундными таймерами, но это чревато

* RSTP/PVRST/MST: порядка 100мс, зависит от топологии и железа

  * Подвержен проблеме count-to-infinity на кольцевых топологиях

### Cisco Resilient Ethernet Protocol

* Протокол блокировки петель для кольцевых топологий

  * Время сходимости порядка 50 мс для кольцевых топологий

  * Требует предварительной натсройки для указания печ кольца/сегмента

* Альтернативные протоколы:

  * ITU-T G.8032: Ethernet Ring Protection Switching (ERPS)

  * RFC 3619: Extreme Networks Ethernet Automatic Protection Swithing

  * Allied Telesis Ethernet Protection Switching Ring (EPSR)

## Проблема отказоустойчивости шлюза

* Кадры пользователей обычно терминируются на маршрутизаторе

* Как бы ни была надежна коммутируемая сеть, при отказе маршрутизатора передача трафика невозможна

* В IPv4 нет штатных механизмов отказоустойчивости шлюза

### Принцип работы FHRP

* FHRP - First Hop Redundancy Protocol 

* Шлюзом по умолчанию узлам назначается виртуальный IP-адрес

  * Маршрутизаторы договариваются, кто обслуживает этот IP-адрес

  * При отказе оставшиеся маршрутизаторы продолжают обслуживание

### Сравнение протоколов FHRP

* Стандартные протоколы

  * VRRP (Virtual Router Redundancy Protocol) - RFC 5798, патентные проблемы

* Проприетарные протоколы

  * HSRP (Hot Sandby Router Protocol) - RFC 2281, лицензируемый Cisco

  * GLBP (Gateway Load Balancing Protocol) - Cisco-специфичный

  * ESRP (Extreme Standby Router Protocol) - Extreme-специфичный

  * R-SMLT (Routed Split multi-link trunking) - Avaya-специфичный

* Непроприетарные протоколы

  * CARP (Common Address Redundancy Protocol) - BSD/Linux, не стандартизован

### HSRP

* Маршрутизаторы HSRP объединяются в группу

* Один из маршрутизаторов в группе выбирается активным за группу

  * Отвечает на запросы ARP предсказуемым виртуальным MAC-адресом

  * Форвардит IP-пакеты в кадрах, приходящих на виртуальный MAC

  * Отправляет hello-пакеты (по умолчанию раз в 3 секунды)

* Другой маршрутизатор выбирается запасным за группу

  * Слушает hello от активного (если не слышит - сам становится активным)

  * Отправляет hello-пакеты (по-умолчанию раз в 3 секунды)

* Все остальные маршрутизаторы (если есть) не делают ничего

  * Слушают hello от запасного, если не слышат - устраивают выборы запасного

### Сосуществование HSRP и STP

* Обычно маршрутизация выполняется на distribution-коммутаторах

  * Для зашиты от петли между access-свитчами может использоваться STP

* STP выберет разные корневые коммутаторы в разных VLAN

  * Простейшая балансировка

  * Роль активного роутера следует совмещать с ролью STP Root

### VRRP

* Стандартный протокол (VRRPv3 - RFC 5798)

  * Похож на HSRP до степени смешения, имеет патентные проблемы с HSRP

* Один из маршрутизаторов в группе выбирается мастером за группу

  * Отвечает на запросы ARP предсказуемым виртуальным MAC-адресом

  * Форвардит IP-пакеты в кадрах, приходящих на виртуальный MAC

  * Отправляет hello-пакеты (по-умолчанию раз в 3 секунды)

* Все остальные маршрутизаторы (если есть) не делают ничего

  * Слушают hello от мастера, если не слышат - устраивают перевыборы 

### GLBP

* Протокол FHRP, основанный на HSRPv2

  * Решает проблему "один работает, остальные сидят без дела"

  * Реботают не больше четырех, остальные сидят без дела

* Основанный на HSRPv2 протокол отказоустойчивости шлюза

  * Выбирается Active Virtual Gateway (диспетчер)

  * AVG назначает до 4 рабочих маршрутизаторов (Active Virtual Forwarder)

  * AVG отвечает на ARP-запросы виртуальными MAC-адресами AVF

  * AVF выполняет маршрутизацию пакетов, приходящих на MAC-адреса AVF

### Проблема выхода в свет

* FHRP может выбрать активный роутер

* Однако это не обязательно решает проблему обработки отказа

> Как правило проблема, когда роутер выполняет резервирование FHRP, но при этом у него ломается выход во внешную сеть решается костылями через скрипты